(window.webpackJsonp=window.webpackJsonp||[]).push([[7],{268:function(t,a,s){"use strict";s.r(a);var e=s(38),n=Object(e.a)({},function(){var t=this,a=t.$createElement,s=t._self._c||a;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"github-actions-で-private-なサブモジュールを簡単に取得する"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#github-actions-で-private-なサブモジュールを簡単に取得する","aria-hidden":"true"}},[t._v("#")]),t._v(" GitHub Actions で Private なサブモジュールを簡単に取得する")]),t._v(" "),s("p",[t._v("GitHub Actions で Private なリポジトリを取得するのは難しいです。")]),t._v(" "),s("p",[t._v("一般的にローカル環境でサブモジュールを取得する場合、 SSH キーを使用します。")]),t._v(" "),s("p",[t._v("Github Action 上では権限が広すぎるため SSH キーを使用するとセキュリティ上の懸念が出てきます。")]),t._v(" "),s("p",[t._v("SSH キーやパーソナルアクセストークンは権限がユーザーに紐付いており、鍵が漏れたときそのユーザーが見ることができるリポジトリがすべて見えてしまったり危険です。")]),t._v(" "),s("p",[t._v("なのでなるべく権限を絞ったキーであるデプロイキーを使用したくなります。")]),t._v(" "),s("p",[t._v("ただ、デプロイキーは一つのリポジトリしかデプロイできないため、複数のサブモジュールがあるとデプロイキーを交換しながらデプロイしなければなりません。")]),t._v(" "),s("p",[t._v("そこで、プライベートリポジトリを簡単に取得できるようにする Action の "),s("a",{attrs:{href:"https://github.com/Mushus/checkout-submodule",target:"_blank",rel:"noopener noreferrer"}},[t._v("Mushus/checkout-submodule"),s("OutboundLink")],1),t._v(" を作りました。")]),t._v(" "),s("h2",{attrs:{id:"使い方"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#使い方","aria-hidden":"true"}},[t._v("#")]),t._v(" 使い方")]),t._v(" "),s("p",[t._v("Github Actions で Private なサブモジュールにチェックアウトするには以下の作業が必要になります。")]),t._v(" "),s("ol",[s("li",[t._v("Action を動かす対象のサブモジュールがあるリポジトリを用意する")]),t._v(" "),s("li",[t._v("SSH キーを生成する")]),t._v(" "),s("li",[t._v("Action を動かすリポジトリにシークレットを登録する")]),t._v(" "),s("li",[t._v("サブモジュールのリポジトリにデプロイキーを登録する")]),t._v(" "),s("li",[t._v("GitHub Actions を設定する")])]),t._v(" "),s("h2",{attrs:{id:"action-を動かす対象のサブモジュールがあるリポジトリを用意する"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#action-を動かす対象のサブモジュールがあるリポジトリを用意する","aria-hidden":"true"}},[t._v("#")]),t._v(" Action を動かす対象のサブモジュールがあるリポジトリを用意する")]),t._v(" "),s("p",[t._v("GitHub Actions を動かす対象のリポジトリが存在しなければなにもはじまりません。")]),t._v(" "),s("h2",{attrs:{id:"ssh-キーを生成する"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#ssh-キーを生成する","aria-hidden":"true"}},[t._v("#")]),t._v(" SSH キーを生成する")]),t._v(" "),s("p",[t._v("SSH キーを生成します。Linux であれば "),s("code",[t._v("ssh-keygen")]),t._v(" コマンドで簡単に作成することができます。 Windows であれば WSL を使用してください。")]),t._v(" "),s("p",[t._v("以下はパスワードとコメントを未指定で "),s("code",[t._v("ed25519")]),t._v(" 形式の "),s("code",[t._v("key.pem")]),t._v(" を生成するコマンドです。")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v('ssh-keygen -t ed25519 -P "" -C "" -f key.pem\n')])])]),s("p",[t._v("詳細は"),s("a",{attrs:{href:"https://qiita.com/wnoguchi/items/a72a042bb8159c35d056",target:"_blank",rel:"noopener noreferrer"}},[t._v("こちら"),s("OutboundLink")],1),t._v("が参考になります。")]),t._v(" "),s("p",[t._v("簡単に作成したい場合"),s("a",{attrs:{href:"https://8gwifi.org/sshfunctions.jsp",target:"_blank",rel:"noopener noreferrer"}},[t._v("オンラインのジェネレータ"),s("OutboundLink")],1),t._v("を使うことができます。ただし、セキュリティの観点であまりおすすめしません。")]),t._v(" "),s("h2",{attrs:{id:"action-を動かすリポジトリにシークレットを登録する"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#action-を動かすリポジトリにシークレットを登録する","aria-hidden":"true"}},[t._v("#")]),t._v(" Action を動かすリポジトリにシークレットを登録する")]),t._v(" "),s("p",[t._v("Action実行側のリポジトリにプライベートキーを設定します。")]),t._v(" "),s("p",[t._v("githubのリポジトリのトップから「 Settings > Secrets > Add a new Secret 」 を順に押下することでシークレット設定ページに遷移できます。")]),t._v(" "),s("p",[t._v("「 Name 」には GitHub Actions 中で使用する識別子を設定します。「 Value 」には SSH キーのプライベートキーを設定します。")]),t._v(" "),s("p",[t._v("登録後はメモせずにプライベートキーは捨ててしまいましょう。")]),t._v(" "),s("h2",{attrs:{id:"サブモジュールのリポジトリにデプロイキーを登録する"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#サブモジュールのリポジトリにデプロイキーを登録する","aria-hidden":"true"}},[t._v("#")]),t._v(" サブモジュールのリポジトリにデプロイキーを登録する")]),t._v(" "),s("p",[t._v("サブモジュール側のリポジトリにパブリックキーを設定します。")]),t._v(" "),s("p",[t._v("githubのリポジトリのトップから「 Settings > Deploy Keys > Add Deploy Key 」 を順に押下することでデプロイキー設定ページに遷移できます。")]),t._v(" "),s("p",[t._v("「 Title 」には後で確認したときにわかる適当な名前を設定し、「 Value 」には SSH キーのパブリックキーを設定します。")]),t._v(" "),s("p",[t._v("登録後はシークレットと同様にメモせずにパブリックキーは捨ててしまいましょう。")]),t._v(" "),s("h2",{attrs:{id:"github-actions-を設定する"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#github-actions-を設定する","aria-hidden":"true"}},[t._v("#")]),t._v(" GitHub Actions を設定する")]),t._v(" "),s("p",[t._v("ここで作成した Action を使用します。")]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" CI\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("on")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("push"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("jobs")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("build")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("runs-on")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" ubuntu"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("latest\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("steps")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("uses")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" actions/checkout@v2\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("uses")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Mushus/checkout"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("submodule@master\n        "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("with")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n          "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("submodulePath")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("YOUR_SUBMODULE_PATH"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n          "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("identifierFile")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" $"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" secret."),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("YOUR_SECRET_PATH"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n")])])]),s("p",[t._v("結果としてこの数行を追加することでデプロイキーを取得できます。")]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("uses")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Mushus/checkout"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("submodule@master\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("with")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("submodulePath")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("YOUR_SUBMODULE_PATH"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("identifierFile")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" $"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" secret."),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("YOUR_SECRET_PATH"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("h2",{attrs:{id:"おわりに"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#おわりに","aria-hidden":"true"}},[t._v("#")]),t._v(" おわりに")]),t._v(" "),s("p",[t._v("これで簡単にプライベートリポジトリを安全にサブモジュールとして使用できるようになりました。")]),t._v(" "),s("p",[t._v("キーも毎回使い捨てますし、漏れたとしても一つのリポジトリしか見ることができません。設定も容易です。")])])},[],!1,null,null,null);a.default=n.exports}}]);